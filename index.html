<!DOCTYPE html>
<html lang="hu">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<meta name="theme-color" content="#1a1f2e">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-title" content="IngatlanApp">
<title>Ingatlan Adatfelv√©tel</title>
<link rel="manifest" href="manifest.json">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
:root {
  --bg:#0f1219; --surface:#1a1f2e; --surface2:#232a3b; --surface3:#2d3548;
  --accent:#c9a84c; --accent2:#e8c97a; --text:#f0ece4; --text2:#a8a49c; --text3:#6b6760;
  --danger:#e05555; --success:#4caf7d; --pending:#e08c30;
  --border:rgba(201,168,76,0.15); --radius:12px;
  --fd:'DM Serif Display',serif; --fb:'DM Sans',sans-serif;
}
*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent}
body{font-family:var(--fb);background:var(--bg);color:var(--text);min-height:100vh;overflow-x:hidden}
.app-header{background:var(--surface);border-bottom:1px solid var(--border);padding:16px 20px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:100}
.app-title{font-family:var(--fd);font-size:1.3rem;color:var(--accent)}
.app-sub{font-size:.7rem;color:var(--text3);letter-spacing:.08em;text-transform:uppercase}
.bottom-nav{position:fixed;bottom:0;left:0;right:0;background:var(--surface);border-top:1px solid var(--border);display:flex;z-index:100;padding-bottom:env(safe-area-inset-bottom)}
.nav-btn{flex:1;display:flex;flex-direction:column;align-items:center;gap:4px;padding:12px 8px;background:none;border:none;color:var(--text3);font-family:var(--fb);font-size:.65rem;letter-spacing:.06em;text-transform:uppercase;cursor:pointer;transition:color .2s}
.nav-btn.active{color:var(--accent)}
.nav-btn svg{width:22px;height:22px}
.screen{display:none;padding:20px 20px 100px}
.screen.active{display:block;animation:fi .25s ease}
@keyframes fi{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
.screen-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px}
.screen-title{font-family:var(--fd);font-size:1.6rem}
.btn-new{background:var(--accent);color:#0f1219;border:none;border-radius:50px;padding:10px 18px;font-family:var(--fb);font-weight:600;font-size:.85rem;cursor:pointer;display:flex;align-items:center;gap:6px}
.filter-bar{display:flex;gap:8px;margin-bottom:16px;overflow-x:auto;padding-bottom:4px;scrollbar-width:none}
.filter-bar::-webkit-scrollbar{display:none}
.filter-chip{background:var(--surface2);border:1px solid var(--border);color:var(--text2);border-radius:50px;padding:6px 14px;font-size:.78rem;white-space:nowrap;cursor:pointer;transition:all .2s}
.filter-chip.active{background:var(--accent);color:#0f1219;border-color:var(--accent);font-weight:600}
.ing-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:16px;margin-bottom:12px;cursor:pointer;transition:border-color .2s,transform .1s}
.ing-card:active{transform:scale(.98)}
.card-head{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:8px}
.card-cim{font-weight:600;font-size:.95rem;flex:1;padding-right:8px}
.sbadge{font-size:.65rem;font-weight:600;letter-spacing:.08em;text-transform:uppercase;padding:3px 10px;border-radius:50px;white-space:nowrap}
.s-aktiv{background:rgba(76,175,125,.15);color:var(--success);border:1px solid rgba(76,175,125,.3)}
.s-fuggoben{background:rgba(224,140,48,.15);color:var(--pending);border:1px solid rgba(224,140,48,.3)}
.s-eladva{background:rgba(201,168,76,.15);color:var(--accent);border:1px solid rgba(201,168,76,.3)}
.s-archiv{background:rgba(107,103,96,.15);color:var(--text3);border:1px solid rgba(107,103,96,.3)}
.card-meta{display:flex;gap:12px;flex-wrap:wrap}
.card-mi{font-size:.78rem;color:var(--text2)}
.card-td{margin-top:10px;padding-top:10px;border-top:1px solid var(--border);font-size:.78rem;color:var(--accent2)}
.empty{text-align:center;padding:60px 20px;color:var(--text3)}
.empty .ico{font-size:3rem;margin-bottom:16px}
.fsec{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);margin-bottom:16px;overflow:hidden}
.fsec-h{padding:14px 16px;background:var(--surface2);display:flex;justify-content:space-between;align-items:center;cursor:pointer;user-select:none}
.fsec-t{font-family:var(--fd);font-size:1rem;color:var(--accent)}
.fsec-b{padding:16px}
.fsec-b.col{display:none}
.frow{margin-bottom:14px}
.frow:last-child{margin-bottom:0}
.frow2{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:14px}
.frow3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin-bottom:14px}
label{display:block;font-size:.72rem;font-weight:500;color:var(--text3);letter-spacing:.08em;text-transform:uppercase;margin-bottom:6px}
input[type=text],input[type=number],input[type=date],input[type=email],input[type=tel],select,textarea{width:100%;background:var(--surface3);border:1px solid var(--border);border-radius:8px;padding:11px 13px;color:var(--text);font-family:var(--fb);font-size:.9rem;outline:none;transition:border-color .2s;-webkit-appearance:none}
input:focus,select:focus,textarea:focus{border-color:var(--accent)}
select option{background:var(--surface3)}
textarea{resize:vertical;min-height:80px}
.cbgrid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
.cbitem{display:flex;align-items:center;gap:8px;background:var(--surface3);border:1px solid var(--border);border-radius:8px;padding:10px 12px;cursor:pointer;transition:all .2s;user-select:none}
.cbitem.on{background:rgba(201,168,76,.12);border-color:rgba(201,168,76,.5)}
.cbbox{width:18px;height:18px;border:2px solid var(--text3);border-radius:4px;display:flex;align-items:center;justify-content:center;flex-shrink:0;transition:all .2s;position:relative}
.cbitem.on .cbbox{background:var(--accent);border-color:var(--accent)}
.cbitem.on .cbbox::after{content:'';position:absolute;width:10px;height:6px;border-left:2px solid #0f1219;border-bottom:2px solid #0f1219;transform:rotate(-45deg) translate(1px,-1px)}
.cblabel{font-size:.8rem;color:var(--text2)}
.cbitem.on .cblabel{color:var(--accent2);font-weight:500}
.hrow{background:var(--surface3);border:1px solid var(--border);border-radius:8px;padding:12px;margin-bottom:8px;position:relative}
.hrow .rmb{position:absolute;top:8px;right:8px;background:rgba(224,85,85,.15);border:none;border-radius:50%;width:26px;height:26px;color:var(--danger);font-size:1rem;cursor:pointer;display:flex;align-items:center;justify-content:center}
.hrow-name{font-size:.82rem;color:var(--text2);margin-bottom:8px;font-weight:600}
.btn-addh{width:100%;background:transparent;border:1px dashed rgba(201,168,76,.3);border-radius:8px;padding:12px;color:var(--accent);font-family:var(--fb);font-size:.85rem;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:6px}
.fgrid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:12px}
.fitem{aspect-ratio:1;border-radius:8px;overflow:hidden;position:relative;background:var(--surface3);border:1px solid var(--border)}
.fitem img{width:100%;height:100%;object-fit:cover}
.fsel{position:absolute;top:4px;left:4px;width:22px;height:22px;background:rgba(15,18,25,.7);border:2px solid rgba(255,255,255,.5);border-radius:50%;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:.7rem;color:transparent}
.fitem.sel .fsel{background:var(--accent);border-color:var(--accent);color:#0f1219}
.frm{position:absolute;top:4px;right:4px;width:22px;height:22px;background:rgba(224,85,85,.8);border:none;border-radius:50%;color:white;font-size:.8rem;cursor:pointer;display:flex;align-items:center;justify-content:center}
.fadd{aspect-ratio:1;background:transparent;border:1px dashed rgba(201,168,76,.3);border-radius:8px;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:4px;color:var(--accent);font-size:.7rem;cursor:pointer}
.fadd svg{width:24px;height:24px}
#sig-canvas{width:100%;height:160px;background:var(--surface3);border:1px solid var(--border);border-radius:8px;touch-action:none;cursor:crosshair}
.sig-hint{font-size:.75rem;color:var(--text3);text-align:center;margin-top:6px}
.btn-clrsig{background:transparent;border:1px solid var(--border);border-radius:8px;padding:8px 16px;color:var(--text2);font-family:var(--fb);font-size:.8rem;cursor:pointer;margin-top:8px}
.btn-p{width:100%;background:var(--accent);color:#0f1219;border:none;border-radius:10px;padding:15px;font-family:var(--fb);font-weight:700;font-size:.95rem;cursor:pointer}
.btn-s{width:100%;background:transparent;color:var(--accent);border:1px solid rgba(201,168,76,.4);border-radius:10px;padding:14px;font-family:var(--fb);font-weight:600;font-size:.9rem;cursor:pointer;margin-top:10px}
.btn-row{display:flex;gap:10px;margin-top:10px}
.btn-row .btn-p,.btn-row .btn-s{margin-top:0}
.back-btn{display:flex;align-items:center;gap:8px;background:none;border:none;color:var(--text2);font-family:var(--fb);font-size:.9rem;cursor:pointer;padding:0;margin-bottom:20px}
.dhero{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:20px;margin-bottom:16px}
.dcim{font-family:var(--fd);font-size:1.4rem;margin-bottom:6px}
.dmeta{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
.dsec{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:16px;margin-bottom:12px}
.dsec-t{font-size:.72rem;font-weight:600;letter-spacing:.1em;text-transform:uppercase;color:var(--accent);margin-bottom:12px}
.dgrid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.di label{font-size:.68rem;color:var(--text3)}
.di .val{font-size:.9rem;margin-top:2px}
.ecrd{background:var(--surface3);border:1px solid var(--border);border-radius:8px;padding:12px;margin-bottom:8px;display:flex;justify-content:space-between;align-items:center}
.en{font-weight:600;font-size:.9rem}
.em{font-size:.78rem;color:var(--text2);margin-top:2px}
.bcall{background:rgba(76,175,125,.15);border:1px solid rgba(76,175,125,.3);border-radius:8px;padding:8px 14px;color:var(--success);font-size:.8rem;cursor:pointer;text-decoration:none;display:flex;align-items:center;gap:4px}
.tdinrow{display:flex;gap:8px;margin-bottom:8px}
.tdinrow input{flex:1}
.btn-addtd{background:var(--accent);color:#0f1219;border:none;border-radius:8px;padding:0 16px;font-weight:700;font-size:1.1rem;cursor:pointer;flex-shrink:0}
.tditem{display:flex;align-items:center;gap:10px;background:var(--surface3);border-radius:8px;padding:10px 12px;margin-bottom:6px}
.tditem.done{opacity:.5}
.tditem.done .tdt{text-decoration:line-through}
.tdchk{width:20px;height:20px;border:2px solid var(--text3);border-radius:50%;flex-shrink:0;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .2s}
.tditem.done .tdchk{background:var(--success);border-color:var(--success)}
.tdt{font-size:.85rem;flex:1}
.toast{position:fixed;bottom:90px;left:50%;transform:translateX(-50%) translateY(20px);background:var(--surface2);border:1px solid var(--border);border-radius:50px;padding:10px 20px;font-size:.85rem;opacity:0;transition:all .3s;z-index:200;white-space:nowrap}
.toast.show{opacity:1;transform:translateX(-50%) translateY(0)}
.modal-ov{position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:300;display:none;align-items:flex-end}
.modal-ov.open{display:flex}
.modal-sh{background:var(--surface);border-radius:20px 20px 0 0;border:1px solid var(--border);padding:24px 20px;width:100%;max-height:85vh;overflow-y:auto}
.modal-t{font-family:var(--fd);font-size:1.2rem;color:var(--accent);margin-bottom:16px;text-align:center}
.modal-hnd{width:40px;height:4px;background:var(--surface3);border-radius:2px;margin:0 auto 20px}
.tipov{position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:400;display:flex;align-items:flex-end}
.tipsh{background:var(--surface);width:100%;border-radius:20px 20px 0 0;padding:24px 20px;max-height:70vh;overflow-y:auto}

.mic-row { display: flex; gap: 8px; align-items: flex-start; }
.mic-row textarea { flex: 1; }
.btn-mic {
  background: var(--surface3);
  border: 1px solid var(--border);
  border-radius: 8px;
  width: 44px;
  min-height: 80px;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  flex-shrink: 0;
  transition: all .2s;
  color: var(--text3);
  font-size: 1.2rem;
}
.btn-mic:active { background: rgba(201,168,76,.15); border-color: var(--accent); }
.btn-mic.listening {
  background: rgba(224,85,85,.15);
  border-color: var(--danger);
  color: var(--danger);
  animation: pulse 1s infinite;
}
@keyframes pulse { 0%,100%{opacity:1} 50%{opacity:.5} }

.tipitem{padding:13px 16px;background:var(--surface3);border:1px solid var(--border);border-radius:8px;margin-bottom:8px;color:var(--text);cursor:pointer;font-size:.9rem}
</style>
</head>
<body>

<header class="app-header">
  <div><div class="app-title">Ingatlan</div><div class="app-sub">Adatkezel≈ë</div></div>
</header>

<div class="screen active" id="screen-lista">
  <div class="screen-header">
    <div class="screen-title">Ingatlanok</div>
    <button class="btn-new" onclick="ujIngatlan()">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" width="16" height="16"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>√öj
    </button>
  </div>
  <div class="filter-bar">
    <div class="filter-chip active" onclick="filterStatus('mind',this)">Mind</div>
    <div class="filter-chip" onclick="filterStatus('aktiv',this)">Akt√≠v</div>
    <div class="filter-chip" onclick="filterStatus('fuggoben',this)">F√ºgg≈ëben</div>
    <div class="filter-chip" onclick="filterStatus('eladva',this)">Eladva</div>
    <div class="filter-chip" onclick="filterStatus('archiv',this)">Arch√≠v</div>
  </div>
  <div id="ing-lista"></div>
</div>

<div class="screen" id="screen-form">
  <button class="back-btn" onclick="goLista()">
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="15 18 9 12 15 6"/></svg>Vissza
  </button>
  <div id="form-wrap"></div>
</div>

<div class="screen" id="screen-detail">
  <button class="back-btn" onclick="goLista()">
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="15 18 9 12 15 6"/></svg>Vissza
  </button>
  <div id="detail-wrap"></div>
</div>

<nav class="bottom-nav">
  <button class="nav-btn active" id="nav-lista" onclick="goLista()">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/></svg>
    Ingatlanok
  </button>
  <button class="nav-btn" onclick="ujIngatlan()">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><circle cx="12" cy="12" r="9"/><line x1="12" y1="8" x2="12" y2="16"/><line x1="8" y1="12" x2="16" y2="12"/></svg>
    √öj felv√©tel
  </button>
  <button class="nav-btn" onclick="goLista()">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><circle cx="11" cy="11" r="7"/><line x1="16.5" y1="16.5" x2="21" y2="21"/></svg>
    Keres√©s
  </button>
</nav>

<div class="toast" id="toast"></div>

<div class="modal-ov" id="modal-erd">
  <div class="modal-sh">
    <div class="modal-hnd"></div>
    <div class="modal-t">√ârdekl≈ëd≈ë hozz√°ad√°sa</div>
    <div class="frow"><label>N√©v</label><input type="text" id="erd-nev" placeholder="Kov√°cs J√°nos"></div>
    <div class="frow"><label>Telefonsz√°m</label><input type="tel" id="erd-tel" placeholder="+36 20 123 4567"></div>
    <div class="frow"><label>Megjegyz√©s</label><input type="text" id="erd-megj" placeholder="pl. 3 szob√°sat keres, max 50M"></div>
    <button class="btn-p" onclick="erdMent()">Ment√©s</button>
    <button class="btn-s" onclick="closeModal()">M√©gsem</button>
  </div>
</div>

<input type="file" id="foto-inp" accept="image/*" multiple style="display:none" onchange="fotoFeltolt(event)">

<script>
// ‚îÄ‚îÄ STATE ‚îÄ‚îÄ
var DB = JSON.parse(localStorage.getItem('ig2') || '[]');
var filterNow = 'mind';
var editId = null;
var detailId = null;
var FOTOK = [];
var HELYEK = [];
var TEENDOK = [];
var SIG = null;
var drawing = false;
var lx = 0, ly = 0;

var KOZM = ['V√≠z','Villany','G√°z','Csatorna','Telefon','K√°belTV','Internet'];
var EXTRA = ['Riaszt√≥','Kl√≠ma','Kaputelefon','Napelem','Medence','Szauna','Lift','T√°rol√≥','Pince'];
var MELL = ['Tul. lap','T√©rk√©pm√°solat','Alaprajz','F√©nyk√©pek','Egy√©b'];
var HTIP = ['Nappali','Szoba','Konyha','√âtkez≈ë','F√ºrd≈ëszoba','WC','Kamra','Gar√°zs','Terasz','Erk√©ly','Pince','El≈ëszoba','Egy√©b'];
var BURK = ['Parketta','Lamin√°lt','Csempe','J√°r√≥lap','Sz≈ënyeg','Beton','M√°rv√°ny','Egy√©b'];
var H_TAR = ['H≈ëszivatty√∫','Kl√≠maf≈±t√©s'];

function dbSave() { localStorage.setItem('ig2', JSON.stringify(DB)); }
function uid() { return Date.now().toString(36) + Math.random().toString(36).substr(2,4); }
function fmtAr(n) {
  if (!n) return '';
  n = parseInt(n);
  if (n >= 1000000) return (n/1000000).toFixed(1).replace('.0','') + ' M Ft';
  if (n >= 1000) return Math.round(n/1000) + ' e Ft';
  return n + ' Ft';
}
function toast(msg) {
  var t = document.getElementById('toast');
  t.textContent = msg; t.classList.add('show');
  setTimeout(function(){ t.classList.remove('show'); }, 2500);
}
function goScreen(id) {
  document.querySelectorAll('.screen').forEach(function(s){ s.classList.remove('active'); });
  document.getElementById('screen-' + id).classList.add('active');
  document.querySelectorAll('.nav-btn').forEach(function(b){ b.classList.remove('active'); });
  var nb = document.getElementById('nav-' + id);
  if (nb) nb.classList.add('active');
}
function goLista() { renderLista(); goScreen('lista'); }
function closeModal() { document.getElementById('modal-erd').classList.remove('open'); }
function filterStatus(s, el) {
  filterNow = s;
  document.querySelectorAll('.filter-chip').forEach(function(c){ c.classList.remove('active'); });
  el.classList.add('active');
  renderLista();
}

// ‚îÄ‚îÄ LISTA ‚îÄ‚îÄ
function renderLista() {
  var el = document.getElementById('ing-lista');
  var list = filterNow === 'mind' ? DB : DB.filter(function(i){ return i.status === filterNow; });
  if (!list.length) {
    el.innerHTML = '<div class="empty"><div class="ico">üè†</div><p>M√©g nincs r√∂gz√≠tett ingatlan.<br>Nyomd az <strong>√öj</strong> gombot.</p></div>';
    return;
  }
  var sl = {aktiv:'Akt√≠v',fuggoben:'F√ºgg≈ëben',eladva:'Eladva',archiv:'Arch√≠v'};
  var h = '';
  list.forEach(function(i) {
    var st = i.status || 'aktiv';
    var ptd = i.teendok && i.teendok.find(function(t){ return !t.done; });
    h += '<div class="ing-card" onclick="openDetail(\'' + i.id + '\')">';
    h += '<div class="card-head"><div class="card-cim">' + (i.cim||'C√≠m n√©lk√ºl') + '</div>';
    h += '<span class="sbadge s-' + st + '">' + (sl[st]||'Akt√≠v') + '</span></div>';
    h += '<div class="card-meta">';
    if (i.jelleg) h += '<span class="card-mi">üèò ' + i.jelleg + '</span>';
    if (i.iranyar) h += '<span class="card-mi">üí∞ ' + fmtAr(i.iranyar) + '</span>';
    if (i.lakter) h += '<span class="card-mi">üìê ' + i.lakter + ' m¬≤</span>';
    if (i.megbizonev) h += '<span class="card-mi">üë§ ' + i.megbizonev + '</span>';
    h += '</div>';
    if (ptd) h += '<div class="card-td">‚ö° ' + ptd.text + '</div>';
    h += '</div>';
  });
  el.innerHTML = h;
}

// ‚îÄ‚îÄ CHECKBOX HELPERS ‚îÄ‚îÄ
function cbGrid(containerId, items, selectedArr) {
  var el = document.getElementById(containerId);
  if (!el) return;
  var sel = selectedArr || [];
  var h = '';
  items.forEach(function(k) {
    var on = sel.indexOf(k) >= 0 ? ' on' : '';
    h += '<div class="cbitem' + on + '" onclick="this.classList.toggle(\'on\')">';
    h += '<div class="cbbox"></div><span class="cblabel">' + k + '</span></div>';
  });
  el.innerHTML = h;
}
function getChecked(containerId) {
  var vals = [];
  document.querySelectorAll('#' + containerId + ' .cbitem.on').forEach(function(el) {
    vals.push(el.querySelector('.cblabel').textContent);
  });
  return vals;
}

// ‚îÄ‚îÄ FORM ‚îÄ‚îÄ
function ujIngatlan() {
  editId = null; FOTOK = []; HELYEK = []; TEENDOK = []; SIG = null;
  renderForm(null);
  goScreen('form');
}
function editIngatlan(id) {
  var ing = DB.find(function(i){ return i.id === id; });
  if (!ing) return;
  editId = id;
  FOTOK = (ing.fotok || []).map(function(f){ return Object.assign({},f); });
  HELYEK = (ing.helyek || []).map(function(h){ return Object.assign({},h); });
  TEENDOK = (ing.teendok || []).map(function(t){ return Object.assign({},t); });
  SIG = ing.alairas || null;
  renderForm(ing);
  goScreen('form');
}

function renderForm(ing) {
  var v = ing || {};
  var w = document.getElementById('form-wrap');

  // Build birtok select
  var bOpts = ['','Azonnal','1 h√≥nap','2 h√≥nap','3 h√≥nap','4 h√≥nap','5 h√≥nap','6 h√≥nap','6 h√≥napon t√∫l'];
  var bSel = '';
  bOpts.forEach(function(o) {
    bSel += '<option value="' + o + '"' + (v.birtok === o ? ' selected' : '') + '>' + (o || 'V√°lassz...') + '</option>';
  });

  // F≈±t√©s select
  var fOpts = ['','G√°zkaz√°n','G√°zcirk√≥','T√°vh≈ë','Elektromos','H≈ëszivatty√∫','Kl√≠maf≈±t√©s','Vegyes','Nincs'];
  var fSel = '';
  fOpts.forEach(function(o) {
    fSel += '<option value="' + o + '"' + (v.futes === o ? ' selected' : '') + '>' + (o || 'V√°lassz...') + '</option>';
  });

  // Gar√°zs select
  var gOpts = ['','Nincs','Gar√°zs','Be√°ll√≥','M√©lygar√°zs','Utcai parkol√≥','Teremgar√°zs'];
  var gSel = '';
  gOpts.forEach(function(o) {
    gSel += '<option value="' + o + '"' + (v.garazs === o ? ' selected' : '') + '>' + (o || 'V√°lassz...') + '</option>';
  });

  var hTarVis = H_TAR.indexOf(v.futes) >= 0 ? '' : 'display:none';
  var tulVis = v.birtok === '6 h√≥napon t√∫l' ? '' : 'display:none';

  var jellegOpts = ['','Lak√°s','H√°z','Nyaral√≥','Telek','Iroda','√úzlet','Egy√©b'];
  var jSel = '';
  jellegOpts.forEach(function(o) {
    jSel += '<option value="' + o + '"' + (v.jelleg === o ? ' selected' : '') + '>' + (o || 'V√°lassz...') + '</option>';
  });

  var h = '<h2 style="font-family:var(--fd);font-size:1.5rem;margin-bottom:20px">' + (editId ? 'Szerkeszt√©s' : '√öj adatfelv√©tel') + '</h2>';

  // MEGB√çZ√ÅS
  h += sec('Megb√≠z√°s adatai', true,
    row('Ingatlan c√≠me *', '<input type="text" id="f-cim" placeholder="pl. Budapest, R√≥zsa u. 12." value="' + esc(v.cim) + '">') +
    row2(
      lbl('Ingatlan jellege') + '<select id="f-jelleg">' + jSel + '</select>',
      lbl('Megb√≠z√°s c√©lja') + '<select id="f-cel"><option value=""' + (!v.cel?' selected':'') + '>V√°lassz...</option><option' + (v.cel==='Elad√°s'?' selected':'') + '>Elad√°s</option><option' + (v.cel==='B√©rlet'?' selected':'') + '>B√©rlet</option></select>'
    ) +
    row2(
      lbl('Ir√°ny√°r (Ft)') + '<input type="number" id="f-iranyar" placeholder="45000000" value="' + esc(v.iranyar) + '">',
      lbl('B√©rleti d√≠j/h√≥ (Ft)') + '<input type="number" id="f-berlet" placeholder="180000" value="' + esc(v.berlet) + '">'
    ) +
    row2(
      lbl('Birtokbaad√°s') + '<select id="f-birtok" onchange="birtokCh()">' + bSel + '</select><input type="text" id="f-btul" placeholder="Pontos√≠t√°s..." value="' + esc(v.birtokTul) + '" style="margin-top:6px;' + tulVis + '">',
      lbl('St√°tusz') + '<select id="f-status"><option value="aktiv"' + ((v.status||'aktiv')==='aktiv'?' selected':'') + '>Akt√≠v</option><option value="fuggoben"' + (v.status==='fuggoben'?' selected':'') + '>F√ºgg≈ëben</option><option value="eladva"' + (v.status==='eladva'?' selected':'') + '>Eladva</option><option value="archiv"' + (v.status==='archiv'?' selected':'') + '>Arch√≠v</option></select>'
    ) +
    row('Megjegyz√©s', '<div class="mic-row"><textarea id="f-megj1" placeholder="Megb√≠z√°ssal kapcsolatos megjegyz√©s">' + esc(v.megjMegb) + '</textarea><button type="button" class="btn-mic" data-target="f-megj1" onclick="startMic(this.dataset.target)">üé§</button></div>')
  );

  // MEGB√çZ√ì
  h += sec('Megb√≠z√≥ adatai', false,
    row('N√©v / Sz√ºlet√©si n√©v', '<input type="text" id="f-mnev" placeholder="Kov√°cs J√°nos" value="' + esc(v.megbizonev) + '">') +
    row('Lakc√≠m', '<input type="text" id="f-mlakcim" placeholder="1234 Budapest, P√©lda u. 1." value="' + esc(v.lakcim) + '">') +
    row2(
      lbl('Tulajdoni h√°nyad') + '<input type="text" id="f-mtulaj" placeholder="1/1" value="' + esc(v.tulajdoni) + '">',
      lbl('Helyrajzi sz√°m') + '<input type="text" id="f-hrsz" placeholder="HRSZ" value="' + esc(v.hrsz) + '">'
    ) +
    row('El√©rhet≈ës√©g', '<input type="text" id="f-mtel" placeholder="+36 20 123 4567" value="' + esc(v.elerhetoseg) + '">') +
    row2(
      lbl('Sz√ºlet√©si hely √©s id≈ë') + '<input type="text" id="f-mszul" placeholder="Budapest, 1975.03.12." value="' + esc(v.szulhely) + '">',
      lbl('Anyja neve') + '<input type="text" id="f-manya" placeholder="Nagy M√°ria" value="' + esc(v.anyja) + '">'
    ) +
    row('Megjegyz√©s', '<div class="mic-row"><textarea id="f-megj2" placeholder="Megb√≠z√≥val kapcsolatos megjegyz√©s">' + esc(v.megjMegbizo) + '</textarea><button type="button" class="btn-mic" data-target="f-megj2" onclick="startMic(this.dataset.target)">üé§</button></div>')
  );

  // INGATLAN
  h += sec('Ingatlan adatai', false,
    row3(
      lbl('Lak√≥ter√ºlet m¬≤') + '<input type="number" id="f-lakter" placeholder="85" value="' + esc(v.lakter) + '">',
      lbl('Telekm√©ret m¬≤') + '<input type="number" id="f-telek" placeholder="450" value="' + esc(v.telek) + '">',
      lbl('Szintek') + '<input type="number" id="f-szint" placeholder="2" value="' + esc(v.szint) + '">'
    ) +
    row2(
      lbl('√âp√≠t√©s √©ve') + '<input type="number" id="f-epites" placeholder="1985" value="' + esc(v.epites) + '">',
      lbl('F≈±t√©s t√≠pusa') + '<select id="f-futes" onchange="futesCh()">' + fSel + '</select>' +
        '<div id="f-htar-row" style="margin-top:8px;' + hTarVis + '">' + lbl('H-tarifa') + '<select id="f-htar"><option value=""' + (!v.htar?' selected':'') + '>Nem ismert</option><option value="Igen"' + (v.htar==='Igen'?' selected':'') + '>Igen ‚Äì van H-tarifa</option><option value="Nem"' + (v.htar==='Nem'?' selected':'') + '>Nem ‚Äì nincs</option></select></div>'
    ) +
    row('Rezsik√∂lts√©g (Ft/h√≥)', '<input type="number" id="f-rezsi" placeholder="35000" value="' + esc(v.rezsi) + '">')
  );

  // K√ñZM≈∞VEK
  h += sec('K√∂zm≈±vek', false, '<div class="cbgrid" id="g-kozm"></div>');

  // EXTRA
  h += sec('Extra felszerelts√©g', false,
    '<div class="cbgrid" id="g-extra"></div>' +
    '<div class="frow" style="margin-top:12px">' + lbl('Egy√©b extra') + '<input type="text" id="f-extrab" placeholder="pl. jakuzzi, borpince..." value="' + esc(v.extraEgyeb) + '"></div>' +
    row('Gar√°zs / Parkol√≥', '<select id="f-garazs">' + gSel + '</select>')
  );

  // HELYIS√âGEK
  h += sec('Helyis√©gek (opcion√°lis)', false, '<div id="g-helyek"></div><button class="btn-addh" onclick="addHely()">+ Helyis√©g hozz√°ad√°sa</button>');

  // FOT√ìK
  h += sec('Fot√≥k', false, '<p style="font-size:.78rem;color:var(--text3);margin-bottom:12px">‚úì jel√∂ld a PDF-be ker√ºl≈ë fot√≥kat (max 4)</p><div class="fgrid" id="g-fotok"></div><button class="btn-s" onclick="document.getElementById(\'foto-inp\').click()" style="margin-top:0">üì∑ Fot√≥ hozz√°ad√°sa</button>');

  // AL√Å√çR√ÅS
  h += sec('L√°ttamoz√°s (al√°√≠r√°s)', false, '<canvas id="sig-canvas"></canvas><p class="sig-hint">A megb√≠z√≥ al√°√≠rja az ujj√°val</p><button class="btn-clrsig" onclick="sigClear()">T√∂rl√©s</button>');

  // TEEND≈êK
  h += sec('K√∂vetkez≈ë teend≈ëk', false, '<div class="tdinrow"><input type="text" id="td-uj" placeholder="pl. Hirdet√©s felad√°sa" onkeydown="if(event.key===\'Enter\')tdAdd()"><button class="btn-addtd" onclick="tdAdd()">+</button></div><div id="g-td"></div>');

  // EGY√âB
  h += sec('Egy√©b megjegyz√©sek', false, '<div class="mic-row"><textarea id="f-egyeb" placeholder="Egy√©b megjegyz√©sek...">' + esc(v.egyeb) + '</textarea><button type="button" class="btn-mic" data-target="f-egyeb" onclick="startMic(this.dataset.target)">üé§</button></div>');

  // MELL√âKLETEK
  h += sec('Mell√©kletek', false, '<div class="cbgrid" id="g-mell"></div>');

  h += '<button class="btn-p" onclick="formMent()" style="margin-top:8px">üíæ Ment√©s</button>';
  h += '<button class="btn-s" onclick="makePDF(null)">üìÑ PDF gener√°l√°s</button>';
  h += '<div style="height:20px"></div>';

  w.innerHTML = h;

  // Init grids
  cbGrid('g-kozm', KOZM, v.kozmuvek);
  cbGrid('g-extra', EXTRA, v.extra);
  cbGrid('g-mell', MELL, v.melleklet);
  renderHelyek();
  renderTd(v.teendok || []);
  renderFotok();
  initSig();
}

function esc(s) { return s ? String(s).replace(/"/g,'&quot;').replace(/</g,'&lt;').replace(/>/g,'&gt;') : ''; }
function lbl(t) { return '<label>' + t + '</label>'; }
function row(l, c) { return '<div class="frow">' + (l ? lbl(l) : '') + c + '</div>'; }
function row2(a, b) { return '<div class="frow2"><div>' + a + '</div><div>' + b + '</div></div>'; }
function row3(a, b, c) { return '<div class="frow3"><div>' + a + '</div><div>' + b + '</div><div>' + c + '</div></div>'; }
function sec(title, open, content) {
  return '<div class="fsec"><div class="fsec-h" onclick="toggleSec(this)"><div class="fsec-t">' + title + '</div><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"' + (open?' style="transform:rotate(180deg)"':'') + '><polyline points="6 9 12 15 18 9"/></svg></div><div class="fsec-b' + (open?'':' col') + '">' + content + '</div></div>';
}
function toggleSec(h) {
  var b = h.nextElementSibling;
  b.classList.toggle('col');
  h.querySelector('svg').style.transform = b.classList.contains('col') ? '' : 'rotate(180deg)';
}
function birtokCh() {
  var v = document.getElementById('f-birtok').value;
  var t = document.getElementById('f-btul');
  if (t) t.style.display = v === '6 h√≥napon t√∫l' ? 'block' : 'none';
}
function futesCh() {
  var v = document.getElementById('f-futes').value;
  var r = document.getElementById('f-htar-row');
  if (r) r.style.display = H_TAR.indexOf(v) >= 0 ? 'block' : 'none';
}

// ‚îÄ‚îÄ HELYIS√âGEK ‚îÄ‚îÄ
function renderHelyek() {
  var el = document.getElementById('g-helyek');
  if (!el) return;
  var h = '';
  HELYEK.forEach(function(hy, i) {
    h += '<div class="hrow"><button class="rmb" onclick="rmHely(' + i + ')">√ó</button>';
    h += '<div class="hrow-name">' + hy.nev + '</div>';
    h += '<div class="frow2" style="margin-bottom:0"><div>' + lbl('Alapter√ºlet (m¬≤)') + '<input type="number" value="' + esc(hy.alap) + '" onchange="HELYEK[' + i + '].alap=this.value" placeholder="m¬≤"></div>';
    h += '<div>' + lbl('Burkolat') + '<select onchange="HELYEK[' + i + '].burkolat=this.value"><option value="">V√°lassz...</option>';
    BURK.forEach(function(b){ h += '<option' + (hy.burkolat===b?' selected':'') + '>' + b + '</option>'; });
    h += '</select></div></div></div>';
  });
  el.innerHTML = h;
}
function addHely() {
  var ov = document.createElement('div');
  ov.className = 'tipov';
  var sh = '<div class="tipsh"><div style="font-family:var(--fd);font-size:1.1rem;color:var(--accent);margin-bottom:16px;text-align:center">Helyis√©g t√≠pusa</div>';
  HTIP.forEach(function(t) {
    sh += '<div class="tipitem" onclick="selHely(\'' + t + '\')">' + t + '</div>';
  });
  sh += '<button onclick="document.querySelector(\'.tipov\').remove()" style="width:100%;background:transparent;border:1px solid var(--border);border-radius:8px;padding:12px;color:var(--text2);font-family:var(--fb);cursor:pointer;margin-top:8px">M√©gsem</button></div>';
  ov.innerHTML = sh;
  document.body.appendChild(ov);
}
function selHely(t) {
  document.querySelector('.tipov').remove();
  HELYEK.push({nev:t,alap:'',burkolat:''});
  renderHelyek();
  var b = document.getElementById('g-helyek').closest('.fsec-b');
  if (b) b.classList.remove('col');
}
function rmHely(i) { HELYEK.splice(i,1); renderHelyek(); }

// ‚îÄ‚îÄ TEEND≈êK ‚îÄ‚îÄ
function renderTd(list) {
  TEENDOK = list;
  var el = document.getElementById('g-td');
  if (!el) return;
  var h = '';
  TEENDOK.forEach(function(t, i) {
    h += '<div class="tditem' + (t.done?' done':'') + '"><div class="tdchk" onclick="tdToggle(' + i + ')">' + (t.done?'‚úì':'') + '</div>';
    h += '<span class="tdt">' + t.text + '</span><span onclick="tdRm(' + i + ')" style="color:var(--danger);cursor:pointer;padding:4px">√ó</span></div>';
  });
  el.innerHTML = h;
}
function tdAdd() {
  var inp = document.getElementById('td-uj');
  if (!inp||!inp.value.trim()) return;
  TEENDOK.push({text:inp.value.trim(),done:false}); inp.value='';
  renderTd(TEENDOK);
}
function tdToggle(i) { TEENDOK[i].done=!TEENDOK[i].done; renderTd(TEENDOK); }
function tdRm(i) { TEENDOK.splice(i,1); renderTd(TEENDOK); }

// ‚îÄ‚îÄ FOT√ìK ‚îÄ‚îÄ
function renderFotok() {
  var el = document.getElementById('g-fotok');
  if (!el) return;
  var h = '';
  FOTOK.forEach(function(f, i) {
    h += '<div class="fitem' + (f.sel?' sel':'') + '"><img src="' + f.url + '" alt="">';
    h += '<div class="fsel" onclick="fToggle(' + i + ')">‚úì</div>';
    h += '<button class="frm" onclick="fRm(' + i + ')">√ó</button></div>';
  });
  h += '<label class="fadd" for="foto-inp"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>Hozz√°ad</label>';
  el.innerHTML = h;
}
function fToggle(i) {
  var selN = FOTOK.filter(function(f){ return f.sel; }).length;
  if (!FOTOK[i].sel && selN >= 4) { toast('Max 4 fot√≥ ker√ºlhet a PDF-be'); return; }
  FOTOK[i].sel = !FOTOK[i].sel; renderFotok();
}
function fRm(i) { FOTOK.splice(i,1); renderFotok(); }
function fotoFeltolt(e) {
  Array.from(e.target.files).forEach(function(f) {
    var r = new FileReader();
    r.onload = function(ev) { FOTOK.push({id:uid(),url:ev.target.result,sel:false}); renderFotok(); };
    r.readAsDataURL(f);
  });
  e.target.value='';
}

// ‚îÄ‚îÄ AL√Å√çR√ÅS ‚îÄ‚îÄ
function initSig() {
  var c = document.getElementById('sig-canvas');
  if (!c) return;
  var ctx = c.getContext('2d');
  c.width = c.offsetWidth || 300; c.height = 160;
  ctx.strokeStyle='#c9a84c'; ctx.lineWidth=2; ctx.lineCap='round';
  if (SIG) { var img=new Image(); img.onload=function(){ctx.drawImage(img,0,0);}; img.src=SIG; }
  function gp(e) { var r=c.getBoundingClientRect(),s=e.touches?e.touches[0]:e; return {x:s.clientX-r.left,y:s.clientY-r.top}; }
  function draw(p) { ctx.beginPath();ctx.moveTo(lx,ly);ctx.lineTo(p.x,p.y);ctx.stroke();lx=p.x;ly=p.y; }
  c.addEventListener('mousedown',function(e){drawing=true;var p=gp(e);lx=p.x;ly=p.y;});
  c.addEventListener('touchstart',function(e){e.preventDefault();drawing=true;var p=gp(e);lx=p.x;ly=p.y;},{passive:false});
  c.addEventListener('mousemove',function(e){if(drawing)draw(gp(e));});
  c.addEventListener('touchmove',function(e){e.preventDefault();if(drawing)draw(gp(e));},{passive:false});
  c.addEventListener('mouseup',function(){drawing=false;SIG=c.toDataURL();});
  c.addEventListener('touchend',function(){drawing=false;SIG=c.toDataURL();});
}
function sigClear() { var c=document.getElementById('sig-canvas'); if(c){c.getContext('2d').clearRect(0,0,c.width,c.height);SIG=null;} }

// ‚îÄ‚îÄ MENT√âS ‚îÄ‚îÄ
function gv(id) { var e=document.getElementById(id); return e?e.value:''; }

function formMent() {
  var cim = gv('f-cim').trim();
  if (!cim) { toast('‚ö†Ô∏è A c√≠m megad√°sa k√∂telez≈ë!'); return; }
  var prev = editId ? DB.find(function(i){return i.id===editId;}) : null;
  var ing = {
    id: editId || uid(),
    cim: cim, jelleg: gv('f-jelleg'), cel: gv('f-cel'),
    iranyar: gv('f-iranyar'), berlet: gv('f-berlet'),
    birtok: gv('f-birtok'), birtokTul: gv('f-btul'),
    status: gv('f-status'), megjMegb: gv('f-megj1'),
    megbizonev: gv('f-mnev'), lakcim: gv('f-mlakcim'),
    tulajdoni: gv('f-mtulaj'), hrsz: gv('f-hrsz'),
    elerhetoseg: gv('f-mtel'), szulhely: gv('f-mszul'),
    anyja: gv('f-manya'), megjMegbizo: gv('f-megj2'),
    lakter: gv('f-lakter'), telek: gv('f-telek'),
    szint: gv('f-szint'), epites: gv('f-epites'),
    futes: gv('f-futes'), htar: gv('f-htar'),
    rezsi: gv('f-rezsi'),
    kozmuvek: getChecked('g-kozm'),
    extra: getChecked('g-extra'),
    extraEgyeb: gv('f-extrab'),
    garazs: gv('f-garazs'),
    melleklet: getChecked('g-mell'),
    egyeb: gv('f-egyeb'),
    helyek: HELYEK.slice(),
    teendok: TEENDOK.slice(),
    fotok: FOTOK.map(function(f){return Object.assign({},f);}),
    alairas: SIG,
    erdeklodok: prev ? (prev.erdeklodok||[]) : [],
    letrehozva: prev ? (prev.letrehozva||new Date().toISOString()) : new Date().toISOString(),
    modositva: new Date().toISOString()
  };
  if (editId) { var idx=DB.findIndex(function(i){return i.id===editId;}); DB[idx]=ing; }
  else { DB.unshift(ing); }
  dbSave();
  toast('‚úì Mentve!');
  setTimeout(goLista, 800);
}

// ‚îÄ‚îÄ DETAIL ‚îÄ‚îÄ
function openDetail(id) {
  detailId = id;
  var ing = DB.find(function(i){return i.id===id;});
  if (!ing) return;
  renderDetail(ing);
  goScreen('detail');
}
function renderDetail(ing) {
  var sl = {aktiv:'Akt√≠v',fuggoben:'F√ºgg≈ëben',eladva:'Eladva',archiv:'Arch√≠v'};
  var st = ing.status||'aktiv';
  var h = '';
  h += '<div class="dhero"><div class="dcim">' + ing.cim + '</div><div class="dmeta">';
  h += '<span class="sbadge s-' + st + '">' + (sl[st]||'Akt√≠v') + '</span>';
  if (ing.jelleg) h += '<span style="color:var(--text2);font-size:.85rem">' + ing.jelleg + '</span>';
  if (ing.iranyar) h += '<span style="color:var(--accent);font-weight:600">' + fmtAr(ing.iranyar) + '</span>';
  h += '</div></div>';

  h += dsec('Megb√≠z√°s',
    di2('C√©l', ing.cel||'‚Äì', 'Birtok √°tad√°s', (ing.birtok||'‚Äì') + (ing.birtokTul?' ('+ing.birtokTul+')':'')) +
    (ing.berlet ? di('B√©rleti d√≠j', fmtAr(ing.berlet)+'/h√≥') : '')
  );

  h += dsec('Megb√≠z√≥',
    di2('N√©v', ing.megbizonev||'‚Äì', 'El√©rhet≈ës√©g', ing.elerhetoseg||'‚Äì') +
    di2('Lakc√≠m', ing.lakcim||'‚Äì', 'Tulaj. h√°nyad', ing.tulajdoni||'‚Äì')
  );

  h += dsec('Ingatlan',
    di2('Alapter√ºlet', ing.lakter?ing.lakter+' m¬≤':'‚Äì', 'Telek', ing.telek?ing.telek+' m¬≤':'‚Äì') +
    di2('Szintek', ing.szint||'‚Äì', '√âp√≠t√©s √©ve', ing.epites||'‚Äì') +
    di2('F≈±t√©s', (ing.futes||'‚Äì')+(ing.htar==='Igen'?' + H-tarifa':''), 'Rezsi', ing.rezsi?ing.rezsi+' Ft/h√≥':'‚Äì') +
    (ing.garazs?di('Gar√°zs/Parkol√≥', ing.garazs):'')
  );

  if (ing.kozmuvek && ing.kozmuvek.length) {
    h += '<div class="dsec"><div class="dsec-t">K√∂zm≈±vek</div><div style="display:flex;flex-wrap:wrap;gap:6px">';
    ing.kozmuvek.forEach(function(k){ h += '<span style="background:rgba(201,168,76,.1);border:1px solid rgba(201,168,76,.2);border-radius:50px;padding:4px 10px;font-size:.75rem;color:var(--accent2)">' + k + '</span>'; });
    h += '</div></div>';
  }

  var extraAll = (ing.extra||[]).concat(ing.extraEgyeb?[ing.extraEgyeb]:[]);
  if (extraAll.length) {
    h += '<div class="dsec"><div class="dsec-t">Extra felszerelts√©g</div><div style="display:flex;flex-wrap:wrap;gap:6px">';
    extraAll.forEach(function(k){ h += '<span style="background:rgba(76,175,125,.1);border:1px solid rgba(76,175,125,.2);border-radius:50px;padding:4px 10px;font-size:.75rem;color:var(--success)">' + k + '</span>'; });
    h += '</div></div>';
  }

  if (ing.helyek && ing.helyek.length) {
    h += '<div class="dsec"><div class="dsec-t">Helyis√©gek</div>';
    h += '<table style="width:100%;border-collapse:collapse;font-size:.82rem"><tr style="color:var(--text3)"><th style="text-align:left;padding:4px 0">Helyis√©g</th><th style="text-align:right">m¬≤</th><th style="text-align:right">Burkolat</th></tr>';
    ing.helyek.forEach(function(hy){ h += '<tr style="border-top:1px solid var(--border)"><td style="padding:6px 0">' + hy.nev + '</td><td style="text-align:right;color:var(--text2)">' + (hy.alap||'‚Äì') + '</td><td style="text-align:right;color:var(--text2)">' + (hy.burkolat||'‚Äì') + '</td></tr>'; });
    h += '</table></div>';
  }

  if (ing.fotok && ing.fotok.length) {
    h += '<div class="dsec"><div class="dsec-t">Fot√≥k</div><div class="fgrid">';
    ing.fotok.forEach(function(f){ h += '<div class="fitem' + (f.sel?' sel':'') + '"><img src="' + f.url + '" alt="">' + (f.sel?'<div class="fsel" style="background:var(--accent);border-color:var(--accent);color:#0f1219">‚úì</div>':'') + '</div>'; });
    h += '</div></div>';
  }

  if (ing.teendok && ing.teendok.length) {
    h += '<div class="dsec"><div class="dsec-t">Teend≈ëk</div>';
    ing.teendok.forEach(function(t){ h += '<div class="tditem' + (t.done?' done':'') + '"><div class="tdchk">' + (t.done?'‚úì':'') + '</div><span class="tdt">' + t.text + '</span></div>'; });
    h += '</div>';
  }

  h += '<div class="dsec"><div class="dsec-t">√ârdekl≈ëd≈ëk</div>';
  if (ing.erdeklodok && ing.erdeklodok.length) {
    ing.erdeklodok.forEach(function(e){ h += '<div class="ecrd"><div><div class="en">' + e.nev + '</div><div class="em">' + (e.megj||'') + '</div></div><a href="tel:' + e.tel + '" class="bcall">üìû H√≠v√°s</a></div>'; });
  } else {
    h += '<p style="color:var(--text3);font-size:.85rem">Nincs √©rdekl≈ëd≈ë</p>';
  }
  h += '<button class="btn-s" style="margin-top:12px" onclick="openErdModal()">+ √ârdekl≈ëd≈ë hozz√°ad√°sa</button></div>';

  if (ing.egyeb) h += '<div class="dsec"><div class="dsec-t">Egy√©b megjegyz√©sek</div><p style="font-size:.88rem;color:var(--text2);line-height:1.6">' + ing.egyeb + '</p></div>';

  h += '<div class="btn-row"><button class="btn-p" onclick="editIngatlan(\'' + ing.id + '\')">‚úèÔ∏è Szerkeszt√©s</button>';
  h += '<button class="btn-s" onclick="makePDF(\'' + ing.id + '\')" style="margin-top:0">üìÑ PDF</button></div>';
  h += '<div style="height:20px"></div>';

  document.getElementById('detail-wrap').innerHTML = h;
}

function dsec(title, content) {
  return '<div class="dsec"><div class="dsec-t">' + title + '</div><div class="dgrid">' + content + '</div></div>';
}
function di(l, v) { return '<div class="di"><label>' + l + '</label><div class="val">' + v + '</div></div>'; }
function di2(l1,v1,l2,v2) { return di(l1,v1)+di(l2,v2); }

// ‚îÄ‚îÄ √âRDEKL≈êD≈êK ‚îÄ‚îÄ
function openErdModal() {
  ['erd-nev','erd-tel','erd-megj'].forEach(function(id){ document.getElementById(id).value=''; });
  document.getElementById('modal-erd').classList.add('open');
}
function erdMent() {
  var ing = DB.find(function(i){return i.id===detailId;});
  if (!ing) return;
  if (!ing.erdeklodok) ing.erdeklodok=[];
  ing.erdeklodok.push({id:uid(),nev:gv('erd-nev'),tel:gv('erd-tel'),megj:gv('erd-megj'),datum:new Date().toLocaleDateString('hu-HU')});
  dbSave(); closeModal(); renderDetail(ing); toast('‚úì √ârdekl≈ëd≈ë mentve!');
}

// ‚îÄ‚îÄ PDF ‚îÄ‚îÄ
function makePDF(id) {
  var ing;
  if (id) {
    ing = DB.find(function(i){return i.id===id;});
  } else {
    ing = {
      cim:gv('f-cim'),jelleg:gv('f-jelleg'),cel:gv('f-cel'),
      iranyar:gv('f-iranyar'),berlet:gv('f-berlet'),
      birtok:gv('f-birtok'),birtokTul:gv('f-btul'),
      megbizonev:gv('f-mnev'),lakcim:gv('f-mlakcim'),
      tulajdoni:gv('f-mtulaj'),hrsz:gv('f-hrsz'),
      elerhetoseg:gv('f-mtel'),
      lakter:gv('f-lakter'),telek:gv('f-telek'),
      szint:gv('f-szint'),epites:gv('f-epites'),
      futes:gv('f-futes'),htar:gv('f-htar'),rezsi:gv('f-rezsi'),
      kozmuvek:getChecked('g-kozm'),
      extra:getChecked('g-extra'),extraEgyeb:gv('f-extrab'),
      garazs:gv('f-garazs'),
      helyek:HELYEK,fotok:FOTOK,alairas:SIG,egyeb:gv('f-egyeb')
    };
  }
  if (!ing) return;
  buildPDF(ing);
}

function buildPDF(ing) {
  var jsPDF = window.jspdf.jsPDF;
  var doc = new jsPDF({unit:'mm',format:'a4'});
  var W=210, M=18, y=20;

  // Header
  doc.setFillColor(15,18,25); doc.rect(0,0,W,40,'F');
  doc.setFillColor(201,168,76); doc.rect(0,38,W,2,'F');
  doc.setTextColor(201,168,76); doc.setFontSize(20); doc.setFont('helvetica','bold');
  doc.text('INGATLAN ADATLAP',M,18);
  doc.setTextColor(180,175,165); doc.setFontSize(9); doc.setFont('helvetica','normal');
  doc.text(new Date().toLocaleDateString('hu-HU'),W-M,18,{align:'right'});
  y=52;

  // C√≠m box
  doc.setFillColor(245,243,238); doc.roundedRect(M,y-6,W-M*2,22,3,3,'F');
  doc.setTextColor(15,18,25); doc.setFontSize(14); doc.setFont('helvetica','bold');
  doc.text(ing.cim||'‚Äì',M+6,y+4);
  if(ing.jelleg){doc.setFontSize(9);doc.setTextColor(80,80,85);doc.setFont('helvetica','normal');doc.text(ing.jelleg+(ing.cel?' ¬∑ '+ing.cel:''),M+6,y+11);}
  if(ing.iranyar){doc.setFontSize(12);doc.setFont('helvetica','bold');doc.setTextColor(201,168,76);doc.text(fmtAr(ing.iranyar),W-M-6,y+4,{align:'right'});}
  y+=28;

  function sh(t) {
    doc.setFillColor(201,168,76);doc.rect(M,y,3,6,'F');
    doc.setFontSize(9);doc.setFont('helvetica','bold');doc.setTextColor(201,168,76);
    doc.text(t.toUpperCase(),M+6,y+5);
    doc.setDrawColor(220,215,205);doc.line(M,y+8,W-M,y+8);
    y+=13;
  }
  function r2(l1,v1,l2,v2) {
    doc.setFontSize(7.5);doc.setFont('helvetica','normal');doc.setTextColor(80,80,85);
    doc.text(l1,M,y);doc.text(l2,W/2+2,y);
    doc.setFontSize(9.5);doc.setFont('helvetica','bold');doc.setTextColor(15,18,25);
    doc.text(v1||'‚Äì',M,y+5.5);doc.text(v2||'‚Äì',W/2+2,y+5.5);
    y+=13;
  }

  sh('Megb√≠z√≥ adatai');
  r2('N√©v',ing.megbizonev,'El√©rhet≈ës√©g',ing.elerhetoseg);
  r2('Lakc√≠m',ing.lakcim,'Tulajdoni h√°nyad',ing.tulajdoni);
  if(ing.hrsz){var bs=(ing.birtok||'')+(ing.birtokTul?' ('+ing.birtokTul+')':'');r2('Helyrajzi sz√°m',ing.hrsz,'Birtok √°tad√°s',bs);}
  y+=2;

  sh('Ingatlan adatai');
  r2('Lak√≥ter√ºlet',ing.lakter?ing.lakter+' m¬≤':'‚Äì','Telekm√©ret',ing.telek?ing.telek+' m¬≤':'‚Äì');
  r2('√âp√≠t√©s √©ve',ing.epites,'Szintek',ing.szint);
  var fs=(ing.futes||'')+(ing.htar==='Igen'?' + H-tarifa':'');
  r2('F≈±t√©s',fs||'‚Äì','Rezsik√∂lts√©g',ing.rezsi?ing.rezsi+' Ft/h√≥':'‚Äì');
  if(ing.garazs) r2('Gar√°zs/Parkol√≥',ing.garazs,'Birtok √°tad√°s',(!ing.hrsz&&ing.birtok)?ing.birtok:'‚Äì');
  y+=2;

  var allK=ing.kozmuvek||[];
  var allE=(ing.extra||[]).concat(ing.extraEgyeb?[ing.extraEgyeb]:[]);

  if(allK.length){
    sh('K√∂zm≈±vek');
    var pr=5,bw=(W-M*2)/pr;
    allK.forEach(function(k,i){
      var col=i%pr,rr=Math.floor(i/pr),x=M+col*bw,ky=y+rr*10;
      doc.setFillColor(245,243,238);doc.roundedRect(x,ky-5,bw-2,8,1.5,1.5,'F');
      doc.setFillColor(201,168,76);doc.circle(x+4,ky-1,1.5,'F');
      doc.setFontSize(8);doc.setFont('helvetica','normal');doc.setTextColor(15,18,25);
      doc.text(k,x+8,ky);
    });
    y+=Math.ceil(allK.length/pr)*10+4;
  }

  if(allE.length){
    sh('Extra felszerelts√©g');
    var pr2=5,bw2=(W-M*2)/pr2;
    allE.forEach(function(k,i){
      var col=i%pr2,rr=Math.floor(i/pr2),x=M+col*bw2,ky=y+rr*10;
      doc.setFillColor(230,245,235);doc.roundedRect(x,ky-5,bw2-2,8,1.5,1.5,'F');
      doc.setFillColor(76,175,125);doc.circle(x+4,ky-1,1.5,'F');
      doc.setFontSize(8);doc.setFont('helvetica','normal');doc.setTextColor(15,18,25);
      doc.text(k,x+8,ky);
    });
    y+=Math.ceil(allE.length/pr2)*10+4;
  }

  if(ing.helyek&&ing.helyek.length){
    sh('Helyis√©gek');
    doc.setFillColor(240,238,235);doc.rect(M,y-4,W-M*2,8,'F');
    doc.setFontSize(7.5);doc.setFont('helvetica','bold');doc.setTextColor(80,80,85);
    doc.text('HELYIS√âG',M+2,y+1);doc.text('ALAP.',M+60,y+1);doc.text('BURKOLAT',M+100,y+1);
    y+=8;
    ing.helyek.forEach(function(hy,i){
      if(i%2===0){doc.setFillColor(250,249,247);doc.rect(M,y-3,W-M*2,8,'F');}
      doc.setFontSize(9);doc.setFont('helvetica','normal');doc.setTextColor(15,18,25);
      doc.text(hy.nev||'‚Äì',M+2,y+2);doc.text(hy.alap?hy.alap+' m¬≤':'‚Äì',M+60,y+2);doc.text(hy.burkolat||'‚Äì',M+100,y+2);
      y+=8;
    });
    y+=4;
  }

  var selF=(ing.fotok||[]).filter(function(f){return f.sel;}).slice(0,4);
  if(selF.length&&y<220){
    sh('Fot√≥k');
    var fw=(W-M*2-(selF.length-1)*4)/Math.min(selF.length,4),fh=fw*.75;
    if(y+fh>280){doc.addPage();y=20;}
    selF.forEach(function(f,i){try{doc.addImage(f.url,'JPEG',M+i*(fw+4),y,fw,fh);}catch(e){}});
    y+=fh+6;
  }

  if(ing.alairas){
    if(y>250){doc.addPage();y=20;}
    try{doc.addImage(ing.alairas,'PNG',M,y,60,20);}catch(e){}
    doc.setDrawColor(220,215,205);doc.line(M,y+22,M+60,y+22);
    doc.setFontSize(8);doc.setTextColor(80,80,85);doc.setFont('helvetica','normal');
    doc.text('Megb√≠z√≥ al√°√≠r√°sa',M,y+28);y+=34;
  }

  var pc=doc.internal.getNumberOfPages();
  for(var i=1;i<=pc;i++){
    doc.setPage(i);
    doc.setFillColor(245,243,238);doc.rect(0,285,W,12,'F');
    doc.setFontSize(7.5);doc.setTextColor(80,80,85);doc.setFont('helvetica','normal');
    doc.text('Bizalmasan kezelend≈ë dokumentum',M,292);
    doc.text(i+' / '+pc,W-M,292,{align:'right'});
  }

  var fn=(ing.cim||'ingatlan').replace(/[^\w\s]/g,'').trim().replace(/\s+/g,'_');
  doc.save('adatlap_'+fn+'.pdf');
  toast('‚úì PDF let√∂ltve!');
}


// ‚îÄ‚îÄ HANGBEVITEL ‚îÄ‚îÄ
var micRecognition = null;
var micTargetId = null;

function startMic(fieldId) {
  var SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  if (!SpeechRecognition) {
    toast('‚ùå Ez a b√∂ng√©sz≈ë nem t√°mogatja a hangbevitelt');
    return;
  }

  // Ha m√°r fut, √°ll√≠tsd le
  if (micRecognition) {
    micRecognition.stop();
    return;
  }

  var btn = event && event.currentTarget ? event.currentTarget : null;
  if (btn) btn.classList.add('listening');

  micTargetId = fieldId;
  micRecognition = new SpeechRecognition();
  micRecognition.lang = 'hu-HU';
  micRecognition.continuous = false;
  micRecognition.interimResults = false;

  micRecognition.onresult = function(e) {
    var text = e.results[0][0].transcript;
    var el = document.getElementById(micTargetId);
    if (el) {
      el.value = el.value ? el.value + ' ' + text : text;
    }
    toast('‚úì R√∂gz√≠tve');
  };

  micRecognition.onerror = function(e) {
    toast('‚ùå Hiba: ' + e.error);
  };

  micRecognition.onend = function() {
    micRecognition = null;
    document.querySelectorAll('.btn-mic.listening').forEach(function(b){ b.classList.remove('listening'); });
  };

  micRecognition.start();
  toast('üé§ Figyelek...');
}

// Init
renderLista();
</script>
</body>
</html>
